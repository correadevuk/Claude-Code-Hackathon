{
  "name": "SlideRx Stage 1 - PDF Extraction & Review Questions",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sliderx-stage1",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "sliderx-stage1"
    },
    {
      "parameters": {
        "functionCode": "// Parse incoming Lambda payload\nconst body = $input.item.json.body;\n\n// Extract parameters\nconst projectId = body.projectId;\nconst s3Bucket = body.s3Bucket || 'sliderx-uploads-dev';\nconst s3Key = body.s3Key;\nconst projectBrief = body.projectBrief;\n\n// Extract userId from s3Key path: uploads/{userId}/{projectId}/...\nconst pathParts = s3Key.split('/');\nconst userId = pathParts[1];\n\nreturn {\n  json: {\n    projectId,\n    userId,\n    s3Bucket,\n    s3Key,\n    projectBrief,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "parse-input",
      "name": "Parse Lambda Payload",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "download",
        "bucketName": "={{$json.s3Bucket}}",
        "fileKey": "={{$json.s3Key}}",
        "options": {}
      },
      "id": "s3-download",
      "name": "S3 Download PDF",
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "aws": {
          "id": "1",
          "name": "AWS S3 SlideRx"
        }
      }
    },
    {
      "parameters": {
        "url": "http://pdf-services:8000/extract-text",
        "method": "POST",
        "sendBody": true,
        "specifyBody": "formData",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "inputDataFieldName": "data",
              "parameterType": "formBinaryData"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "pdf-extract",
      "name": "PDF Service - Extract Text",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Combine extracted text with project context\nconst extractedText = $input.item.json.text || $input.item.json.extractedText;\nconst projectBrief = $node['Parse Lambda Payload'].json.projectBrief;\nconst projectId = $node['Parse Lambda Payload'].json.projectId;\nconst userId = $node['Parse Lambda Payload'].json.userId;\n\nreturn {\n  json: {\n    projectId,\n    userId,\n    extractedText,\n    projectBrief,\n    textLength: extractedText?.length || 0\n  }\n};"
      },
      "id": "prepare-ai-input",
      "name": "Prepare AI Input",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$credentials.openRouterApiKey}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "anthropic/claude-3.5-sonnet"
            },
            {
              "name": "messages",
              "value": "={{[\n  {\n    role: 'user',\n    content: `You are analyzing a business presentation PDF. Extract a slide-by-slide summary.\n\nPresentation Text:\n${$json.extractedText}\n\nBusiness Context:\n- Success Metric: ${$json.projectBrief.successMetric}\n- Industry: ${$json.projectBrief.industry}\n- Problem Solved: ${$json.projectBrief.problemSolved}\n\nProvide output in this JSON format:\n{\n  \"slides\": [\n    {\n      \"index\": 1,\n      \"title\": \"Slide Title\",\n      \"bullets\": [\"Key point 1\", \"Key point 2\", \"Key point 3\"]\n    }\n  ]\n}\n\nAnalyze each slide and extract the most important points as bullets.`\n  }\n]}}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "ai-analysis",
      "name": "AI Analysis - OpenRouter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1250, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "OpenRouter API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Parse AI response and format for API callback\nconst aiResponse = $input.item.json;\nconst userId = $node['Parse Lambda Payload'].json.userId;\nconst projectId = $node['Parse Lambda Payload'].json.projectId;\n\n// Extract summary from AI response\nlet summary;\ntry {\n  const content = aiResponse.choices[0].message.content;\n  // Try to parse as JSON first\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    summary = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found in response');\n  }\n} catch (error) {\n  // Fallback: create basic summary structure\n  summary = {\n    slides: [\n      {\n        index: 1,\n        title: 'Summary Not Available',\n        bullets: ['AI analysis failed to parse', 'Please retry']\n      }\n    ]\n  };\n}\n\n// Define the 3 review questions (fixed structure from Postman)\nconst reviewAndRefine = [\n  {\n    id: 'targetAudience',\n    type: 'select',\n    label: 'Who is this presentation primarily aimed at?',\n    options: [\n      'Investors',\n      'Potential customers',\n      'Internal leadership',\n      'Strategic partners'\n    ],\n    required: true,\n    userAnswer: ''\n  },\n  {\n    id: 'coreMessage',\n    type: 'longText',\n    label: 'What is the key message or takeaway you want the audience to remember?',\n    required: true,\n    userAnswer: ''\n  },\n  {\n    id: 'businessGoal',\n    type: 'select',\n    label: 'What best describes your main business goal for this presentation?',\n    options: [\n      'Fundraising / attracting investors',\n      'Product launch or marketing',\n      'Internal alignment and strategy',\n      'Client acquisition or sales enablement'\n    ],\n    required: true,\n    userAnswer: ''\n  }\n];\n\nreturn {\n  json: {\n    projectId,\n    userId,\n    summary,\n    reviewAndRefine\n  }\n};"
      },
      "id": "format-callback",
      "name": "Format API Callback",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "url": "=https://f9yntj41f4.execute-api.eu-central-1.amazonaws.com/dev/projects/{{$json.projectId}}/ai/callback",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-user-id",
              "value": "={{$json.userId}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify({\n  userId: $json.userId,\n  summary: $json.summary,\n  reviewAndRefine: $json.reviewAndRefine\n})}}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "api-callback",
      "name": "POST to API Callback",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{{\n  success: true,\n  projectId: $node['Parse Lambda Payload'].json.projectId,\n  message: 'Stage 1 completed successfully',\n  status: 'needs_review'\n}}}",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook Response - Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.error}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-s3-error",
      "name": "Check S3 Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 500],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.error}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-extract-error",
      "name": "Check Extract Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 500],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.error}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-ai-error",
      "name": "Check AI Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 500],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "functionCode": "// Log error and format error response\nconst errorNode = $input.item.json;\nconst projectId = $node['Parse Lambda Payload']?.json?.projectId || 'unknown';\n\nconst errorMessage = errorNode.error?.message || errorNode.message || 'Unknown error';\nconst errorStep = $node.name;\n\nconsole.error(`Stage 1 Error at ${errorStep}:`, errorMessage);\n\nreturn {\n  json: {\n    success: false,\n    projectId,\n    error: errorMessage,\n    failedAt: errorStep,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "handle-error",
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "responseCode": 500,
        "options": {}
      },
      "id": "webhook-error-response",
      "name": "Webhook Response - Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 600]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Parse Lambda Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Lambda Payload": {
      "main": [
        [
          {
            "node": "S3 Download PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S3 Download PDF": {
      "main": [
        [
          {
            "node": "PDF Service - Extract Text",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check S3 Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF Service - Extract Text": {
      "main": [
        [
          {
            "node": "Prepare AI Input",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Extract Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare AI Input": {
      "main": [
        [
          {
            "node": "AI Analysis - OpenRouter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Analysis - OpenRouter": {
      "main": [
        [
          {
            "node": "Format API Callback",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check AI Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format API Callback": {
      "main": [
        [
          {
            "node": "POST to API Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST to API Callback": {
      "main": [
        [
          {
            "node": "Webhook Response - Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check S3 Error": {
      "main": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Extract Error": {
      "main": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check AI Error": {
      "main": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Error": {
      "main": [
        [
          {
            "node": "Webhook Response - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-10T00:00:00.000Z",
  "versionId": "1"
}
